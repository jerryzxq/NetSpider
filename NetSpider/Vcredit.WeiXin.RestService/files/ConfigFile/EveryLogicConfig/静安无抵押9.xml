<?xml version="1.0" encoding="utf-8" ?>
<RunModule>
  <BusinessLogic ID="9" Description="静安无抵押模式">
    
    <Flow Type="CreatePreBillFlowLogic" Description="创建前置账单配置">
      <Step Type="CreatePreBillItemFlowStep" Description="创建前置账单配置">
        <IfOperation Condition='bus.LoanKind=="LOANKIND/ANJIADAI"' Description="安家贷">
          <Operation RuleId="100000" SolutionId="100006" CanDeduct="true" Description="手续费+保证金">
            <Operation RuleId="200000" SolutionId="200011"  Description="保证金算法" />
            <Operation RuleId="200000" SolutionId="200012"  Description="手续费算法" />
          </Operation>
          <Else>
            <Operation RuleId="100000" SolutionId="100007" CanDeduct="true" Description="手续费">
              <Operation RuleId="200000" SolutionId="200012"  Description="手续费算法" />
            </Operation>
          </Else>
        </IfOperation>

      </Step>
    </Flow>
    
    <Flow Type="CreateBillFlowLogic" Description="创建账单配置">
      <Step Type="CreateBillItemFlowStep" Description="创建基础科目配置">
        <Operation RuleId="100000" SolutionId="100001" Description="本金、利息、服务费">
          <IfOperation Condition="IsLastBill(bus)" >
            <Operation RuleId="200000" SolutionId="200002" Description="最后一期账单本金算法"/>
            <Else>
              <Operation RuleId="200000" SolutionId="200001"  Description="前期账单本金算法"/>
            </Else>
          </IfOperation>
          <Operation RuleId="200000" SolutionId="200003" Description="月利息算法" />
          <Operation RuleId="200000" SolutionId="200004" Description="月服务费算法" />
          <Operation RuleId="200000" SolutionId="200007" Description="月管理费算法" />
        </Operation>
      </Step>
    </Flow>

    <Flow Type="DeductFlowLogic" Description="自动扣款配置">
      <Step Type="DeductPackageFlowStep" Description="自动扣款配置">
        <Operation RuleId="300000" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" SolutionId="300012" SpanBill="false" OldestBill="true"  Description="不跨账单从最远一期扣款打包科目:手续费">
          <AfterOperation>
            <IfOperation Condition ="instruction==nil or instruction.SendResult==0" Description="打包成功">
              <Operation RuleId="300000" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" SolutionId="300011" SpanBill="false" OldestBill="true" Description="保证金">
                <AfterOperation>
                  <IfOperation Condition ="instruction==nil or instruction.SendResult==0" Description="打包成功">
                    <Operation RuleId="300000" ToAccount="bus.LendingSideID" DeductPlatform="GetDeductPlatform(bus)" SolutionId="300005" SpanBill="false" OldestBill="true" Description="本金+利息+管理费+本息扣失+罚息">
                      <AfterOperation>
                        <IfOperation Condition ="instruction==nil or instruction.SendResult==0" Description="打包成功">
                          <Operation RuleId="300000" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" SolutionId="300004" SpanBill="false" OldestBill="true" Description="服务费+服务费扣失"/>
                          <Else>
                            <IfOperation Condition ="instruction~=nil and (instruction.DeductItem=='' or string.find(instruction.DeductItem,'21')~=nil or string.find(instruction.DeductItem,'23')~=nil)" Description="失败后，原来的科目包含本息扣失或者罚息">
                              <Operation RuleId="300000" ToAccount="bus.LendingSideID" DeductPlatform="GetDeductPlatform(bus)" SolutionId="300002" SpanBill="false" OldestBill="true" Description="本金+利息+管理费"/>
                            </IfOperation>
                          </Else>
                        </IfOperation>
                      </AfterOperation>
                    </Operation>
                  </IfOperation>
                </AfterOperation>
              </Operation>
            </IfOperation>
          </AfterOperation>
        </Operation>
      </Step>
    </Flow>

    <Flow Type="AdvCloanFlowLogic" Description="提前清贷逻辑配置">
      <Step Type="AdvCloanPackageFlowStep" Description="提前清贷打包规则">
        <Operation RuleId="300000" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" SolutionId="300001" SpanBill="true" OldestBill="true"  Description="跨账单从最远一期扣款打包科目:所有科目">
        </Operation>
      </Step>
    </Flow>

    <Flow Type="GeneCapLostFlowLogic" Description="生成本息扣失">
      <Step Type="CapLostPackageFlowStep" Description="生成本息扣失科目">
        <Operation RuleId="400000" SolutionId="400001"  Description="产生本息扣失科目:本金+利息+管理费"/>
      </Step>
    </Flow>

    <Flow Type="GeneSerLostFlowLogic" Description="服务费扣失">
      <Step Type="SerLostPackageFlowStep" Description="生成服务费扣失科目">
        <Operation RuleId="500000" SolutionId="500001"  Description="产生本息扣失科目:服务费"/>
      </Step>
    </Flow>

    <Flow Type="GenePenaFlowLogic" Description="产生罚息科目">
      <Step Type="PenaPackageFlowStep">
        <Operation RuleId="600000" SolutionId="600002"  Description="产生罚息科目:本金+利息+管理费"/>
      </Step>
    </Flow>
    
    <Flow Type="ManualDeductFlowLogic" Description="手工扣款配置">
      <Step Type="ManualPackageFlowStep">
        <IfOperation Condition="bus.CLoanStatus==7" >
          <Operation RuleId="300000" SolutionId="300001" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" SpanBill="ture" OldestBill="true" EnoughBill="true" EnoughBillItem="true" Description="提前清贷,跨账单，足额" />
          <Else>
            <Operation SpanBill="false" OldestBill="true" DeductPlatform="GetDeductPlatform(bus)" EnoughBillItem="false" Description="静安小贷2+2合同 手工扣款非足额（自有资金）,不跨账单，非足额">
              <Operation RuleId="300000" SolutionId="300012" ToAccount="bus.ServiceSideID"  DeductPlatform="GetDeductPlatform(bus)" Description="手续费"/>
              <Operation RuleId="300000" SolutionId="300011" ToAccount="bus.ServiceSideID"  DeductPlatform="GetDeductPlatform(bus)" Description="保证金"/>
              <Operation RuleId="300000" SolutionId="300026" ToAccount="bus.LendingSideID"  DeductPlatform="GetDeductPlatform(bus)" Description="本金"/>
              <Operation RuleId="300000" SolutionId="300027" ToAccount="bus.LendingSideID"  DeductPlatform="GetDeductPlatform(bus)" Description="利息"/>
              <Operation RuleId="300000" SolutionId="300029" ToAccount="bus.LendingSideID"  DeductPlatform="GetDeductPlatform(bus)" Description="管理费"/>
              <Operation RuleId="300000" SolutionId="300013" ToAccount="bus.LendingSideID"  DeductPlatform="GetDeductPlatform(bus)" Description="本息扣失"/>
              <Operation RuleId="300000" SolutionId="300015" ToAccount="bus.LendingSideID"  DeductPlatform="GetDeductPlatform(bus)" Description="罚息"/>
              <Operation RuleId="300000" SolutionId="300008" ToAccount="bus.ServiceSideID"  DeductPlatform="GetDeductPlatform(bus)" Description="服务费"/>
              <Operation RuleId="300000" SolutionId="300014" ToAccount="bus.ServiceSideID"  DeductPlatform="GetDeductPlatform(bus)" Description="服务费扣失"/>
            </Operation>
          </Else>
        </IfOperation>
      </Step>
      <Step Type="ManualLitigationFlowStep" Description="诉讼账单的配置">
        <Operation SpanBill="false" EnoughBillItem="false" DeductPlatform="GetDeductPlatform(bus)" Description="诉讼账单优先级配置">
          <Operation RuleId="300000" SolutionId="300026" ToAccount="bus.LendingSideID"  DeductPlatform="GetDeductPlatform(bus)" Description="本金"/>
          <Operation RuleId="300000" SolutionId="300027" ToAccount="bus.LendingSideID"  DeductPlatform="GetDeductPlatform(bus)" Description="利息"/>
          <Operation RuleId="300000" SolutionId="300029" ToAccount="bus.LendingSideID"  DeductPlatform="GetDeductPlatform(bus)" Description="月管理费"/>
          <Operation RuleId="300000" SolutionId="300008" ToAccount="bus.ServiceSideID"  DeductPlatform="GetDeductPlatform(bus)" Description="服务费"/>
          <Operation RuleId="300000" SolutionId="300028" ToAccount="bus.LendingSideID"  DeductPlatform="GetDeductPlatform(bus)" Description="月担保管理费"/>
          <Operation RuleId="300000" SolutionId="300014" ToAccount="bus.ServiceSideID"  DeductPlatform="GetDeductPlatform(bus)" Description="服务费扣失"/>
          <Operation RuleId="300000" SolutionId="300017" ToAccount="bus.ServiceSideID"  DeductPlatform="GetDeductPlatform(bus)" Description="诉讼费"/>
          <Operation RuleId="300000" SolutionId="300018" ToAccount="bus.ServiceSideID"  DeductPlatform="GetDeductPlatform(bus)" Description="诉讼违约金"/>
        </Operation>
      </Step>
    </Flow>

    <Flow Type="ConfigBillItemLogic" Description="科目名称配置">
      <Step Type="ConfigBillItemFlowStep" Description="科目名称配置">
        <Operation Description="科目名称配置">
          return {[1]="月本金",[2]="月利息",[3]="月服务费",[9]="月管理费",[21]="本息扣失",
          [22]="服务费扣失",[23]="罚息",[10]="手续费"}
        </Operation>
      </Step>
    </Flow>

    <Flow Type="ConfigCompanyLogic" Description="显示公司配置">
      <Step Type="ConfigCompanyFlowStep" Description="显示公司配置">
        <Operation Description="显示公司">
          return {[5]=bus.LendingSideKey,[1]=bus.ServiceSideKey}
        </Operation>
      </Step>
    </Flow>
  </BusinessLogic>
</RunModule>