<?xml version="1.0" encoding="utf-8" ?>
<RunModule>
  <BusinessLogic ID="11" Description="P2P模式">
    <Flow Type="CreateBillFlowLogic" Description="创建账单配置">
      <Step Type="CreateBillItemFlowStep" Description="创建基础科目配置">
        <Operation RuleId="100000" SolutionId="100013" Description="本金+利息+月服务费+月平台管理费">
			<IfOperation Condition="IsLastBill(bus)" Description="最后一期账单">
				<Operation RuleId="200000" SolutionId="200026" Description="月本金算法" />
				<Operation RuleId="200000" SolutionId="200027" Description="月服务费算法" />
				<Else Description="前几期账单">
					<Operation RuleId="200000" SolutionId="200024" Description="月本金算法" />
					<Operation RuleId="200000" SolutionId="200020" Description="月服务费算法" />
				</Else>
			</IfOperation>
		  <Operation RuleId="200000" SolutionId="200025" Description="月利息算法" />
		  <Operation RuleId="200000" SolutionId="200021" Description="月平台管理费" />
        </Operation>
      </Step>
    </Flow>

    <Flow Type="DeductFlowLogic" Description="自动扣款配置">
      <Step Type="DeductPackageFlowStep" Description="自动扣款配置">
        <Operation RuleId="300000" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" SolutionId="300001" SpanBill="false" OldestBill="true"  Description="不跨账单从最远一期扣款打包科目:所有科目">
          <AfterOperation>
            <IfOperation Condition ="instruction~=nil and instruction.SendResult &gt; 0" Description="打包失败">
              <Operation RuleId="300000" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" SolutionId="300035" SpanBill="false" OldestBill="true" Description="平台管理费+服务费">
              </Operation>
            </IfOperation>
          </AfterOperation>
        </Operation>
      </Step>
    </Flow>
   
    <Flow Type="AdvCloanFlowLogic" Description="提前清贷逻辑配置">
      <Step Type="AdvCloanPackageFlowStep" Description="提前清贷打包规则">
        <Operation RuleId="300000" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" SolutionId="300001" SpanBill="true" OldestBill="true"  Description="跨账单从最远一期扣款打包科目:所有科目">
        </Operation>
      </Step>
    </Flow>

    <Flow Type="GeneDeriveBillItemFlowLogic" Description="生成其他衍生科目配置">
      <Step Type="DeriveBillItemFlowStep" Description="违约金+扣款失败服务费">
        <Operation RuleId="700000" SolutionId="700002"  Description="产生违约金：本金+利息">
          <Operation RuleId="200000" SolutionId="200022" Description="违约金算法" />
        </Operation>
		<Operation RuleId="700000" SolutionId="700003"  Description="产生扣款失败服务费：本金+利息+服务费+平台管理费">
          <Operation RuleId="200000" SolutionId="200023" Description="扣款失败服务费算法" />
        </Operation>
      </Step>
    </Flow>

    <Flow Type="GenePenaFlowLogic" Description="产生罚息科目">
      <Step Type="PenaPackageFlowStep">
        <Operation RuleId="600000" SolutionId="600003"  Description="产生罚息科目:本金+利息"/>
      </Step>
    </Flow>

    <Flow Type="ManualDeductFlowLogic" Description="手工扣款配置">
      <Step Type="ManualPackageFlowStep">
        <IfOperation Condition="bus.CLoanStatus==7" >
          <Operation RuleId="300000" SolutionId="300001" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" SpanBill="ture" OldestBill="true" EnoughBill="true" EnoughBillItem="true" Description="提前清贷,跨账单，足额" />
          <Else>
            <Operation SpanBill="true" OldestBill="true" DeductPlatform="GetDeductPlatform(bus)"  EnoughBillItem="true" Description="跨账单，足额">
              <Operation RuleId="300000" SolutionId="300036" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" Description="月平台管理费"/>
              <Operation RuleId="300000" SolutionId="300008" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" Description="服务费"/>
              <Operation RuleId="300000" SolutionId="300039" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" Description="扣款失败服务费"/>
              <Operation RuleId="300000" SolutionId="300037" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" Description="违约金+罚息+本金+利息"/>
            </Operation>
          </Else>
        </IfOperation>
      </Step>

      <Step Type="ManualLitigationFlowStep" Description="诉讼账单的配置">
        <Operation SpanBill="false" EnoughBillItem="false" DeductPlatform="GetDeductPlatform(bus)" Description="诉讼账单优先级配置">
          <Operation RuleId="300000" SolutionId="300036" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" Description="月平台管理费"/>
          <Operation RuleId="300000" SolutionId="300008" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" Description="服务费"/>
          <Operation RuleId="300000" SolutionId="300026" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" Description="本金"/>
          <Operation RuleId="300000" SolutionId="300027" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" Description="利息"/>
          <Operation RuleId="300000" SolutionId="300017" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" Description="诉讼费"/>
          <Operation RuleId="300000" SolutionId="300018" ToAccount="bus.ServiceSideID" DeductPlatform="GetDeductPlatform(bus)" Description="诉讼违约金"/>
        </Operation>
      </Step>

    </Flow>

    <Flow Type="ConfigBillItemLogic" Description="科目名称配置">
      <Step Type="ConfigBillItemFlowStep" Description="科目名称配置">
        <Operation Description="科目名称配置">
          return {[1]="月本金",[2]="月利息",[3]="月服务费",[14]="月平台管理费",[39]="违约金",[40]="扣款失败服务费",[23]="罚息"}
        </Operation>
      </Step>
    </Flow>

    <Flow Type="ConfigCompanyLogic" Description="显示公司配置">
      <Step Type="ConfigCompanyFlowStep" Description="显示公司配置">
        <Operation Description="显示公司">
          return {[1]=bus.ServiceSideKey}
        </Operation>
      </Step>
    </Flow>
  </BusinessLogic>
</RunModule>